(function(e){function t(t,r,i,s,o,u){t.prepend('<div class="ftagShadow" id="ftagShadow1"></div>');t.prepend('<div class="ftagShadow" id="ftagShadow2"></div>');t.prepend('<div class="ftagShadow" id="ftagShadow3"></div>');t.prepend('<div class="ftagShadow" id="ftagShadow4"></div>');n(".ftagShadow",r.shadowStyle,i);e("#ftagShadow1").css({width:s.imageWidth+"px",height:s.top-u+"px",top:u+"px",left:o+"px"});e("#ftagShadow2").css({width:s.left-o+"px",height:s.height+"px",top:s.top,left:o+"px"});e("#ftagShadow3").css({width:s.imageWidth-s.width-s.left+o+"px",height:s.height+"px",top:s.top,left:s.left+s.width+"px"});e("#ftagShadow4").css({width:s.imageWidth+"px",height:s.imageHeight+u-s.top-s.height+"px",top:s.top+s.height+"px",left:o+"px"})}function n(t,n,r){if(n){e(t).addClass(n)}else{e(t).css(r)}}function r(e){var t=e;while(t.css("position")==="static"||t.css("position")===undefined){if(t.parent().prop("tagName")==="BODY"){break}t=t.parent()}return t}function i(e){this.options=e;return this}e.fn.ftag=function(s){function k(e,t,n,r){var i;if(t==="0"){i='<div class="tagClass" id="'+e+'" objectid="'+t+'">'+n}else{i='<div class="tagClass" id="'+e+'" objectid="'+t+'"><span';if(r.onTagClick){i=i+' onclick="'+r.onTagClick+"("+t+')">'+n+"</span>"}else{i=i+">"+n+"</span>"}}if(r.edit===true){i=i+'&nbsp;&nbsp;<span class="removeTag '+r.removeButtonClass+'">';if(r.removeButtonClass===""&&r.removeButtonText===""){i=i+"[x]</span>"}else{i=i+r.removeButtonText+"</span>"}}i=i+"</div>";return i}var o=false,u=false,a=0,f=0,l=0,c=0,h={border:"1px #229922 solid","border-radius":"5px",padding:"5px 7px 5px 7px",position:"static",margin:"10px","background-color":"#88EE88",display:"inline-block"},p={border:"0",position:"absolute","z-index":"9999",margin:"0",padding:"0"},d={position:"absolute","z-index":"9999",border:"2px solid #990000",width:"10px",height:"10px",margin:"0",padding:"0"},v={position:"absolute","z-index":"9999",opacity:"0.5","background-color":"#777777",margin:"0",padding:"0"},m="ftag",g=false,y=e(this),b=null,w=e(this).offset(),E=e(this).position(),S=null,x,T;if(!s){console.log("Plugin error: No parameters");return null}if(typeof s==="string"){switch(s){case"stop":b=y.parent();b.off("click");b.unbind("mousemove");var N=y.data("_ftag"),s=N.options;e(s.tagsHolder).off("click",".tagClass .removeTag");e(s.tagSelectWindow+" "+s.tagSelectWindowSave).unbind("click");e(s.tagSelectWindow+" "+s.tagSelectWindowClose).unbind("click");return this;case"get":b=y.parent();var C=[];b.children(".areaClass").each(function(){var t=e(this);C.push({title:t.attr("title"),objectid:t.attr("objectid"),id:parseInt(t.attr("id"),10),left:Math.ceil(parseInt(t.css("left"),10)-E.left),top:Math.ceil(parseInt(t.css("top"),10)-E.top),width:parseInt(t.css("width"),10),height:parseInt(t.css("height"),10)})});return C}}else if(typeof s==="object"){if(!s.tagSelectWindow){console.log("Plugin error: tagSelectWindow is not specified");return null}if(!s.tagSelectWindowSave){console.log("Plugin error: tagSelectWindowSave is not specified");return null}if(!s.tagSelectWindowClose){console.log("Plugin error: tagSelectWindowClose is not specified");return null}if(!s.tagTextInput){console.log("Plugin error: tagTextInput is not specified");return null}if(!s.tagValue){console.log("Plugin error: tagValue is not specified");return null}if(!s.tagsHolder){console.log("Plugin error: tagHolder is not specified");return null}var s=e.extend({},e.fn.ftag.defaults,s||{});e(s.tagSelectWindowSave).attr("imageId",y.attr("id"));e(s.tagsHolder).attr("imageId",y.attr("id"));var N=e(this).data("_ftag");if(N){N.options=s;console.log("ok")}else{S=new i(s,y);y.data("_ftag",S)}if(y.parent().attr("id")===m+"-"+y.attr("id")){y.parent().find(".areaClass").remove();y.parent().find(".ftagShadow").remove()}else{y.wrap('<div id="'+m+"-"+y.attr("id")+'" style="display: inline-block; padding:0; margin:0;"></div>')}b=y.parent();e(s.tagsHolder).empty();b.unbind("click");b.unbind("mousemove");e(s.tagsHolder).off("mouseenter",".tagClass");e(s.tagsHolder).off("mouseleave",".tagClass");e(s.tagSelectWindow+" "+s.tagSelectWindowSave).unbind("click");e(s.tagSelectWindow+" "+s.tagSelectWindowClose).unbind("click");for(x=0;x!==s.tags.length;x++){T=k(s.tags[x].id,s.tags[x].objectid,s.tags[x].title,s);e(s.tagsHolder).append(T);n('.tagClass[id="'+s.tags[x].id+'"]',s.tagsStyle,h);b.prepend('<div class="areaClass" id="'+s.tags[x].id+'" objectid="'+s.tags[x].objectid+'" title="'+s.tags[x].title+'"></div>');n('div.areaClass[id="'+s.tags[x].id+'"]',s.areaShowStyle,p);E=e(this).position();b.children('div.areaClass[id="'+s.tags[x].id+'"]').css({width:parseInt(s.tags[x].width,10)+"px",height:parseInt(s.tags[x].height,10)+"px",top:parseInt(s.tags[x].top,10)+E.top+"px",left:parseInt(s.tags[x].left,10)+E.left+"px"})}e(s.tagsHolder).on("click",".tagClass .removeTag",function(){var t=e(this).parent().attr("id"),n=e(this).parent().parent(),r=n.attr("imageId"),i=e("#"+r);N=i.data("_ftag"),s=N.options;n.children('.tagClass[id="'+t+'"]').remove();e(".ftagShadow").remove();i.parent().children('.areaClass[id="'+t+'"]').remove();for(x=0;x!==s.tags.length;x++){if(s.tags[x].id==t){s.tags.splice(x,1);break}}if(i.parent().children('.areaClass[id="'+t+'"]')>0){console.log("Error: not all tagged areas have been removed")}});e(s.tagsHolder).on("mouseenter",".tagClass",function(){var n=e(this).parent().attr("imageId"),r=e("#"+n),i=e("#"+n).data("_ftag"),s=i.options,o=r.parent(),u=o.children('.areaClass[id="'+e(this).attr("id")+'"]'),a=r.position(),f=0;if(s.areaShowStyle){f=Math.ceil(parseFloat(u.css("border-width"),10))}t(o,i.options,v,{top:parseInt(u.css("top"),10)+f,left:parseInt(u.css("left"),10)+f,width:parseInt(u.css("width"),10),height:parseInt(u.css("height"),10),imageWidth:parseInt(r.css("width"),10),imageHeight:parseInt(r.css("height"),10)},Math.ceil(a.left),Math.ceil(a.top))});e(s.tagsHolder).on("mouseleave",".tagClass",function(){b.children(".ftagShadow").remove()});if(s.edit!==true){return this}e(s.tagSelectWindow+" "+s.tagSelectWindowSave).click(function(){var t=e(this).attr("imageId"),r=e("#"+t).data("_ftag"),i=r.options,s=e("#"+t).position();b=e("#"+t).parent(),title=e(i.tagTextInput).val(),objectId=e(i.tagValue).val(),area=b.children(".areaClass.new");e(i.tagSelectWindow).hide();u=false;o=false;if(i.areaEditStyle){area.removeClass(i.areaEditStyle)}n(area,i.areaShowStyle,p);var a=0;for(x=0;x!==i.tags.length;x++){if(parseInt(i.tags[x].id,10)>a){a=i.tags[x].id}}a++;area.attr({title:title,objectid:objectId,id:a});i.tags.push({title:area.attr("title"),objectid:area.attr("objectid"),id:area.attr("id"),left:Math.ceil(parseInt(area.css("left"),10)-s.left),top:Math.ceil(parseInt(area.css("top"),10)-s.top),width:parseInt(area.css("width"),10),height:parseInt(area.css("height"),10)});var f=k(a,objectId,title,i);e(i.tagsHolder).append(f);n(i.tagsHolder+' .tagClass[id="'+a+'"]',i.tagsStyle,h);if(i.chosenObjectClass){e("."+i.chosenObjectClass).removeClass(i.chosenObjectClass)}e(i.tagTextInput).val("");e(i.tagValue).val("0");if(i.ontagSelectWindowClose){i.ontagSelectWindowClose()}b.children("div.areaClass").remove();s=e("#"+t).position();for(x=0;x!==i.tags.length;x++){b.prepend('<div class="areaClass" id="'+i.tags[x].id+'" objectid="'+i.tags[x].objectid+'" title="'+i.tags[x].title+'"></div>');n('div.areaClass[id="'+i.tags[x].id+'"]',i.areaShowStyle,p);b.children('div.areaClass[id="'+i.tags[x].id+'"]').css({width:parseInt(i.tags[x].width,10)+"px",height:parseInt(i.tags[x].height,10)+"px",top:parseInt(i.tags[x].top,10)+s.top+"px",left:parseInt(i.tags[x].left,10)+s.left+"px"})}});e(s.tagSelectWindowClose).click(function(){e(s.tagSelectWindow).hide();if(s.chosenObjectClass){e("."+s.chosenObjectClass).removeClass(s.chosenObjectClass)}e(s.tagTextInput).val("");e(s.tagValue).val("0");b.children(".areaClass.new").remove();u=false;o=false;if(s.ontagSelectWindowClose){s.ontagSelectWindowClose()}});b.click(function(t){var i,s;console.log("click");if(!u){var h=e(this),p=h.children("img").first(),v=p.offset(),m=p.position(),y=p.data("_ftag"),b=y.options,w,E;if(r(h.parent()).css("position")==="static"){g=true;i=Math.ceil(v.left);coeffY=Math.ceil(v.top)}else{i=Math.ceil(m.left);coeffY=Math.ceil(m.top)}if(o){u=true;e(b.tagSelectWindow).css({position:"absolute","z-index":"10000",top:f+v.top-coeffY+"px",left:l+v.left-i+20+"px"});e(b.tagSelectWindow).show();if(b.ontagSelectWindowShow){b.ontagSelectWindowShow()}}else{w=parseInt(p.css("width"),10);E=parseInt(p.css("height"),10);h.prepend('<div class="areaClass new" style="position: absolute;"></div>');n("div.areaClass.new",b.areaEditStyle,d);a=Math.ceil(t.pageX);f=Math.ceil(t.pageY);if(!g){a=a-v.left+i;f=f-v.top+coeffY}h.children(".areaClass.new").css({left:a+"px",top:f+"px"});o=true;h.mousemove(function(t){var n=e(this),s=n.children(".areaClass.new");if(!u&&o){var h=n.children("img").first().offset(),p=n.children("img").first().position();if(r(n.parent()).css("position")==="static"){i=Math.ceil(h.left);coeffY=Math.ceil(h.top);l=Math.ceil(t.pageX);c=Math.ceil(t.pageY)}else{i=Math.ceil(p.left);coeffY=Math.ceil(p.top);l=Math.ceil(t.pageX-h.left+p.left);c=Math.ceil(t.pageY-h.top+p.top)}if(l>i&&l<w+i&&c>coeffY&&c<E+coeffY){if(l<a){s.css("left",l+"px");s.css("width",a-l+"px")}else{s.css("left",a+"px");s.css("width",l-a+"px")}if(c<f){s.css("top",c+"px");s.css("height",f-c+"px")}else{s.css("top",f+"px");s.css("height",c-f+"px")}}}})}}})}return this};e.fn.ftag.defaults={edit:true,removeButtonClass:"",removeButtonText:"",onTagClick:"",tags:[]}})(jQuery)
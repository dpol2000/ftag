(function(e){function t(t,r,i,s,o,u){t.prepend('<div class="ftagShadow" id="ftagShadow1"></div>');t.prepend('<div class="ftagShadow" id="ftagShadow2"></div>');t.prepend('<div class="ftagShadow" id="ftagShadow3"></div>');t.prepend('<div class="ftagShadow" id="ftagShadow4"></div>');n(".ftagShadow",r.shadowStyle,i);e("#ftagShadow1").css({width:s.imageWidth+"px",height:s.top-u+"px",top:u+"px",left:o+"px"});e("#ftagShadow2").css({width:s.left-o+"px",height:s.height+"px",top:s.top,left:o+"px"});e("#ftagShadow3").css({width:s.imageWidth-s.width-s.left+o+"px",height:s.height+"px",top:s.top,left:s.left+s.width+"px"});e("#ftagShadow4").css({width:s.imageWidth+"px",height:s.imageHeight+u-s.top-s.height+"px",top:s.top+s.height+"px",left:o+"px"})}function n(t,n,r){if(n){e(t).addClass(n)}else{e(t).css(r)}}function r(e){var t=e;while(t.css("position")==="static"||t.css("position")===undefined){if(t.parent().prop("tagName")==="BODY"){break}t=t.parent()}return t}function i(e){this.options=e;return this}e.fn.ftag=function(r){function C(e,t,n,r){var i;if(t==="0"){i='<div class="tagClass" id="'+e+'" objectid="'+t+'">'+n}else{i='<div class="tagClass" id="'+e+'" objectid="'+t+'"><span';if(r.onTagClick){i=i+' onclick="'+r.onTagClick+"("+t+')">'+n+"</span>"}else{i=i+">"+n+"</span>"}}if(r.edit===true){i=i+'&nbsp;&nbsp;<span class="removeTag '+r.removeButtonClass+'">';if(r.removeButtonClass===""&&r.removeButtonText===""){i=i+"[x]</span>"}else{i=i+r.removeButtonText+"</span>"}}i=i+"</div>";return i}var s=false,o=false,u=0,a=0,f=0,l=0,c={border:"1px #229922 solid","border-radius":"5px",padding:"5px 7px 5px 7px",position:"static",margin:"10px","background-color":"#88EE88",display:"inline-block"},h={border:"0",position:"absolute","z-index":"9999",margin:"0",padding:"0"},p={position:"absolute","z-index":"9999",border:"2px solid #990000",width:"10px",height:"10px",margin:"0",padding:"0"},d={position:"absolute","z-index":"9999",opacity:"0.5","background-color":"#777777",margin:"0",padding:"0"},v="ftag",m=false,g=e(this),y=null,b=e(this).offset(),w=e(this).position(),E=null,S,x;if(!r){console.log("Plugin error: No parameters");return null}if(typeof r==="string"){switch(r){case"stop":y=g.parent();y.off("click");y.unbind("mousemove");var T=g.data("_ftag"),r=T.options;e(r.tagsHolder).off("click",".tagClass .removeTag");e(r.tagSelectWindow+" "+r.tagSelectWindowSave).unbind("click");e(r.tagSelectWindow+" "+r.tagSelectWindowClose).unbind("click");return this;case"get":var T=g.data("_ftag");var N=T.options.tags;return N}}else if(typeof r==="object"){if(!r.tagSelectWindow){console.log("Plugin error: tagSelectWindow is not specified");return null}if(!r.tagSelectWindowSave){console.log("Plugin error: tagSelectWindowSave is not specified");return null}if(!r.tagSelectWindowClose){console.log("Plugin error: tagSelectWindowClose is not specified");return null}if(!r.tagTextInput){console.log("Plugin error: tagTextInput is not specified");return null}if(!r.tagValue){console.log("Plugin error: tagValue is not specified");return null}if(!r.tagsHolder){console.log("Plugin error: tagHolder is not specified");return null}var r=e.extend({},e.fn.ftag.defaults,r||{});e(r.tagSelectWindowSave).attr("imageId",g.attr("id"));e(r.tagsHolder).attr("imageId",g.attr("id"));var T=e(this).data("_ftag");if(T){T.options=r}else{E=new i(r,g);g.data("_ftag",E)}if(g.parent().attr("id")===v+"-"+g.attr("id")){g.parent().find(".areaClass").remove();g.parent().find(".ftagShadow").remove()}else{g.wrap('<div id="'+v+"-"+g.attr("id")+'" style="display: inline-block; padding:0; margin:0; position: relative;"></div>')}y=g.parent();y.css({width:g.css("width")});e(r.tagsHolder).empty();y.unbind("click");y.unbind("mousemove");e(r.tagsHolder).off("mouseenter",".tagClass");e(r.tagsHolder).off("mouseleave",".tagClass");e(r.tagsHolder).off("click",".tagClass");e(r.tagSelectWindow+" "+r.tagSelectWindowSave).unbind("click");e(r.tagSelectWindow+" "+r.tagSelectWindowClose).unbind("click");for(S=0;S!==r.tags.length;S++){x=C(r.tags[S].id,r.tags[S].objectid,r.tags[S].title,r);e(r.tagsHolder).append(x);n('.tagClass[id="'+r.tags[S].id+'"]',r.tagsStyle,c);y.prepend('<div class="areaClass" id="'+r.tags[S].id+'" objectid="'+r.tags[S].objectid+'" title="'+r.tags[S].title+'"></div>');n('div.areaClass[id="'+r.tags[S].id+'"]',r.areaShowStyle,h);w=g.position();y.children('div.areaClass[id="'+r.tags[S].id+'"]').css({width:parseInt(r.tags[S].width,10)+"px",height:parseInt(r.tags[S].height,10)+"px",top:parseInt(r.tags[S].top,10)+w.top-e(window).scrollTop()+"px",left:parseInt(r.tags[S].left,10)+w.left+"px"})}e(r.tagsHolder).on("click",".tagClass .removeTag",function(){var t=e(this).parent().attr("id"),n=e(this).parent().parent(),r=n.attr("imageId"),i=e("#"+r),s=i.data("_ftag"),o=s.options;n.children('.tagClass[id="'+t+'"]').remove();e(".ftagShadow").remove();i.parent().children('.areaClass[id="'+t+'"]').remove();for(S=0;S!==o.tags.length;S++){if(o.tags[S].id==t){o.tags.splice(S,1);break}}if(i.parent().children('.areaClass[id="'+t+'"]')>0){console.log("Error: not all tagged areas have been removed")}});e(r.tagsHolder).on("mouseenter",".tagClass",function(){var n=e(this).parent().attr("imageId"),r=e("#"+n),i=e("#"+n).data("_ftag"),s=i.options,o=r.parent(),u=o.children('.areaClass[id="'+e(this).attr("id")+'"]'),a=r.position(),f=0;if(s.areaShowStyle){f=Math.ceil(parseFloat(u.css("border-width"),10))}t(o,i.options,d,{top:parseInt(u.css("top"),10)+f,left:parseInt(u.css("left"),10)+f,width:parseInt(u.css("width"),10),height:parseInt(u.css("height"),10),imageWidth:parseInt(r.css("width"),10),imageHeight:parseInt(r.css("height"),10)},Math.ceil(a.left),Math.ceil(a.top))});e(r.tagsHolder).on("mouseleave",".tagClass",function(){y.children(".ftagShadow").remove()});if(r.edit!==true){return this}e(r.tagSelectWindow+" "+r.tagSelectWindowSave).click(function(){var t=e(this).attr("imageId"),r=e("#"+t).data("_ftag"),i=r.options,u=e("#"+t).position(),a=e("#"+t).parent(),f=e(i.tagTextInput).val(),l=e(i.tagValue).val(),p=a.children(".areaClass.new");if(f===""){return}e(i.tagSelectWindow).hide();o=false;s=false;if(i.areaEditStyle){p.removeClass(i.areaEditStyle)}n(p,i.areaShowStyle,h);var d=0;for(S=0;S!==i.tags.length;S++){if(parseInt(i.tags[S].id,10)>d){d=i.tags[S].id}}d++;p.attr({title:f,objectid:l,id:d});var v=Math.ceil(parseInt(p.css("top"),10)-u.top);i.tags.push({title:p.attr("title"),objectid:p.attr("objectid"),id:p.attr("id"),left:Math.ceil(parseInt(p.css("left"),10)-u.left),top:v,width:parseInt(p.css("width"),10),height:parseInt(p.css("height"),10)});var m=C(d,l,f,i);e(i.tagsHolder).append(m);n(i.tagsHolder+' .tagClass[id="'+d+'"]',i.tagsStyle,c);if(i.chosenObjectClass){e("."+i.chosenObjectClass).removeClass(i.chosenObjectClass)}e(i.tagTextInput).val("");e(i.tagValue).val("0");if(i.ontagSelectWindowClose){i.ontagSelectWindowClose()}a.children(".areaClass.new").removeClass("new")});e(r.tagSelectWindowClose).click(function(){e(r.tagSelectWindow).hide();if(r.chosenObjectClass){e("."+r.chosenObjectClass).removeClass(r.chosenObjectClass)}e(r.tagTextInput).val("");e(r.tagValue).val("0");y.children(".areaClass.new").remove();o=false;s=false;if(r.ontagSelectWindowClose){r.ontagSelectWindowClose()}});y.click(function(t){var r,i;if(!o){var c=e(this),h=c.children("img").first(),d=h.offset(),v=h.position(),m=h.data("_ftag"),g=m.options,y,b;r=Math.ceil(v.left);coeffY=Math.ceil(v.top);if(s){o=true;e(g.tagSelectWindow).css({position:"absolute","z-index":"10000",top:a+d.top-coeffY+"px",left:f+d.left-r+20+"px"});e(g.tagSelectWindow).show();if(g.ontagSelectWindowShow){g.ontagSelectWindowShow()}}else{y=parseInt(h.css("width"),10);b=parseInt(h.css("height"),10);c.prepend('<div class="areaClass new" style="position: absolute;"></div>');n("div.areaClass.new",g.areaEditStyle,p);u=Math.ceil(t.pageX);a=Math.ceil(t.pageY);u=u-d.left+r;a=a-d.top+coeffY;c.children(".areaClass.new").css({left:u+"px",top:a+"px"});s=true;c.mousemove(function(t){var n=e(this),i=n.children(".areaClass.new");if(!o&&s){var c=n.children("img").first().offset(),h=n.children("img").first().position();r=Math.ceil(h.left);coeffY=Math.ceil(h.top);f=Math.ceil(t.pageX-c.left+h.left);l=Math.ceil(t.pageY-c.top+h.top);if(f>r&&f<y+r&&l>coeffY&&l<b+coeffY){if(f<u){i.css("left",f+"px");i.css("width",u-f+"px")}else{i.css("left",u+"px");i.css("width",f-u+"px")}if(l<a){i.css("top",l+"px");i.css("height",a-l+"px")}else{i.css("top",a+"px");i.css("height",l-a+"px")}}}})}}})}return this};e.fn.ftag.defaults={edit:true,removeButtonClass:"",removeButtonText:"",onTagClick:"",tags:[]}})(jQuery)
